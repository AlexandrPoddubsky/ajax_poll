(function ($) {

/**
 * @file
 * Provides AJAX-voting capabilities to the normal Poll voting form.
 */

/**
 * Behavior to add AJAX voting support to polls.
 */
Drupal.behaviors.ajaxPoll = {};
Drupal.behaviors.ajaxPoll.attach = function(context) {
  $('form.ajax-poll:not(.ajax-poll-processed)', context).addClass('ajax-poll-processed').each(function() {
    // Find the form and poll wrapper items that will be affected.
    var $form = $(this);
    var $pollWrapper;

    // Find all the settings for this form.
    var url = $form.find('input[name=ajax_url]').val();
    var disabledText = $form.find('input[name=ajax_text]').val();
    var enabledText = $form.find('input.form-submit').val();

    // Find container, either the ajax poll wrapper, or the results wrapper div.
    $pollWrapper = $form.closest(".ajax-poll-wrapper, .poll-results");

    // Disable submit button until a choice has been made.
    $pollWrapper.find('.poll-view-voting input.form-submit').attr('disabled', 'disabled');

    $('input[name=choice]').click(function() {
      $pollWrapper.find('.poll-view-voting input.form-submit').removeAttr('disabled');
    });

    // Set up the options for the AJAX voting mechanism.
    var options = {
      url: url,
      beforeSubmit: function(values, form, options) {
        if (disabledText) {
          $form.find('input.form-submit').attr('disabled', 'disabled').val(disabledText);
        }
      },
      success: function(response, status) {
        // On success, replace the poll content with the new content.
        if (response.status) {
          $('.messages').remove();

          $pollWrapper.replaceWith(response.messages + response.output);

          // The action attribute will be the path of the AJAX Poll menu
          // callback. We fix this here for consistency, even though this will
          // be replaced by the AJAX Poll beforeSubmit() function above.
          $pollWrapper.find('form').attr('action', window.location.pathname);

          Drupal.attachBehaviors($pollWrapper.parent().get(0));
        }
      },
      complete: function(response, status) {
        $form.find('input.form-submit').attr('disabled', '').val(enabledText);

        if (status == 'error' || status == 'parsererror') {
          $('.messages').remove();

          $form.prepend(Drupal.theme('ajaxPollError'));
        }
      },
      dataType: 'json',
      type: 'POST'
    };

    // Add the handlers to the Poll form through the jquery.form.js library.
    $form.ajaxForm(options)
  });
};

/**
 * A fallback error that is shown upon a complete failure.
 *
 * This error is only used when the server cannot return a properly themed
 * error. This is usually because the server is unavailable or because the JSON
 * returned is invalid JSON.
 *
 * The second situation is most frequently caused by modules appending extra
 * information to requests and causing improper JSON. Modules that may do this
 * include Devel, Memcache Admin, and other development modules that output
 * debugging code.
 */
Drupal.theme.prototype.ajaxPollError = function() {
  return '<div class="messages error">' + Drupal.t('A parsing or network error has occurred.') + '</div>';
};

})(jQuery);
